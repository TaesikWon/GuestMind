{% extends "base.html" %}
{% block title %}SoulStay ì±—ë´‡ | ê³ ê° ìƒë‹´{% endblock %}
{% block content %}

<div class="card shadow-sm mx-auto" style="max-width: 600px;">
  <div class="card-body p-4">
    <h4 class="card-title text-center mb-3 text-brown">ğŸ§­ SoulStay ê³ ê° ì±—ë´‡</h4>

    <!-- Chat window -->
    <div id="chat-box" class="border rounded p-3 mb-3"
         style="height: 420px; overflow-y: auto; background-color: #fffaf5;">
      <div class="text-center text-muted mt-3">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš” ğŸ’¬</div>
    </div>

    <!-- Input -->
    <form id="chat-form" class="d-flex">
      <input id="user-input" type="text" class="form-control me-2"
             placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required>
      <button type="submit" class="btn btn-primary">ì „ì†¡</button>
    </form>
  </div>
</div>

<script>
const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');

function appendMessage(sender, text, emotion=null) {
  const msg = document.createElement('div');
  msg.classList.add('mb-2');

  // ê°ì •ë³„ ìƒ‰ìƒ
  let bubbleColor = '#f0e5da'; // ê¸°ë³¸
  if (emotion === 'positive') bubbleColor = '#e8d5b7';
  if (emotion === 'negative') bubbleColor = '#d9b5a0';
  if (emotion === 'neutral')  bubbleColor = '#eae3dc';

  msg.innerHTML = sender === 'user'
    ? `<div class="text-end">
         <span class="px-3 py-2 rounded-pill text-light" style="background-color:#7b5e57;">${text}</span>
       </div>`
    : `<div class="text-start">
         <span class="px-3 py-2 rounded-pill" style="background-color:${bubbleColor}; color:#3a2b28;">
           ${text}
         </span>
       </div>`;

  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const message = userInput.value.trim();
  if (!message) return;

  appendMessage('user', message);
  userInput.value = '';

  const res = await fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message })
  });
  const data = await res.json();

  appendMessage('bot', data.response || 'ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', data.emotion);
});
</script>
{% endblock %}
