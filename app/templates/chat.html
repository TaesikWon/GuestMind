<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SoulStay ì±—ë´‡</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<style>
body { background-color: #f8f9fa; }
.chat-container { max-width: 750px; margin: 40px auto; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
.chat-body { height: 500px; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
.message { margin-bottom: 12px; position: relative; }
.user-msg { text-align: right; }
.bot-msg { text-align: left; }
.msg-bubble { display: inline-block; padding: 10px 14px; border-radius: 16px; max-width: 80%; }
.user-msg .msg-bubble { background-color: #007bff; color: white; }
.bot-msg .msg-bubble { background-color: #e9ecef; }
.emotion { font-weight: 600; margin-bottom: 4px; }
.emotion.positive { color: #28a745; }
.emotion.neutral { color: #ffc107; }
.emotion.negative { color: #dc3545; }
.timestamp { font-size: 0.8em; color: #999; margin-top: 2px; }
.loading { color: #6c757d; font-style: italic; }
.stats-panel {
  position: absolute; top: 10px; right: 10px;
  background: rgba(255,255,255,0.9); border: 1px solid #ddd;
  border-radius: 8px; padding: 8px 12px; font-size: 0.9em;
}
.stats-panel span { margin: 0 5px; font-weight: 600; }
.stats-panel .positive { color: #28a745; }
.stats-panel .neutral { color: #ffc107; }
.stats-panel .negative { color: #dc3545; }
</style>
</head>
<body>
<div class="chat-container">
  <!-- ê°ì • í†µê³„ ë¯¸ë‹ˆ íŒ¨ë„ -->
  <div class="stats-panel">
    ğŸ˜Š <span class="positive">0</span> |
    ğŸ˜ <span class="neutral">0</span> |
    ğŸ˜ <span class="negative">0</span>
  </div>

  <div class="chat-body" id="chatBody">
    <div class="text-center text-muted mt-2">
      ğŸ’¬ SoulStay ì±—ë´‡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>í˜¸í…” í›„ê¸°ë¥¼ ì…ë ¥í•´ ê°ì • ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”.
    </div>
  </div>

  <div class="p-3 border-top d-flex justify-content-between align-items-center">
    <form id="chatForm" class="d-flex flex-grow-1 me-2">
      <input id="userInput" class="form-control me-2" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required>
      <button id="sendBtn" class="btn btn-primary">ë³´ë‚´ê¸°</button>
    </form>
    <button id="summaryBtn" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#summaryModal">ìš”ì•½</button>
  </div>
</div>

<!-- ğŸ“Š Bootstrap Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ê°ì • ë¶„ì„ ìš”ì•½</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>ğŸ˜Š ê¸ì •: <span id="sumPositive">0</span></p>
        <p>ğŸ˜ ì¤‘ë¦½: <span id="sumNeutral">0</span></p>
        <p>ğŸ˜ ë¶€ì •: <span id="sumNegative">0</span></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
const form = document.getElementById("chatForm");
const chatBody = document.getElementById("chatBody");
const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const posEl = document.querySelector(".stats-panel .positive");
const neuEl = document.querySelector(".stats-panel .neutral");
const negEl = document.querySelector(".stats-panel .negative");

function getTime() {
  const now = new Date();
  return now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}
function scrollToBottom() {
  chatBody.scrollIntoView({ behavior: "smooth", block: "end" });
}
function updateStats(emotion) {
  if (emotion === "ê¸ì •") posEl.textContent = +posEl.textContent + 1;
  else if (emotion === "ì¤‘ë¦½") neuEl.textContent = +neuEl.textContent + 1;
  else if (emotion === "ë¶€ì •") negEl.textContent = +negEl.textContent + 1;
  // ëª¨ë‹¬ì—ë„ ë°˜ì˜
  document.getElementById("sumPositive").textContent = posEl.textContent;
  document.getElementById("sumNeutral").textContent = neuEl.textContent;
  document.getElementById("sumNegative").textContent = negEl.textContent;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const message = input.value.trim();
  if (!message) return;

  chatBody.innerHTML += `
    <div class="message user-msg">
      <div class="msg-bubble">${message}</div>
      <div class="timestamp">${getTime()}</div>
    </div>`;
  scrollToBottom();
  input.value = "";
  sendBtn.disabled = true;

  const loadingMsg = document.createElement("div");
  loadingMsg.classList.add("message", "bot-msg", "loading");
  loadingMsg.innerHTML = "<div class='msg-bubble'>â³ ì‘ë‹µ ìƒì„± ì¤‘...</div>";
  chatBody.appendChild(loadingMsg);
  scrollToBottom();

  const res = await fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  });
  const data = await res.json();
  loadingMsg.remove();
  sendBtn.disabled = false;
  input.focus();

  let icon = "ğŸ˜", emotionClass = "neutral";
  if (data.emotion === "ê¸ì •") { icon = "ğŸ˜Š"; emotionClass = "positive"; }
  else if (data.emotion === "ë¶€ì •") { icon = "ğŸ˜"; emotionClass = "negative"; }

  chatBody.innerHTML += `
    <div class="message bot-msg">
      <div class="msg-bubble">
        <div class="emotion ${emotionClass}">${icon} ê°ì •: ${data.emotion}</div>
        <div><strong>ìœ ì‚¬ ì‚¬ë¡€:</strong> ${data.similar_case}</div>
        <div><strong>ì‘ë‹µ:</strong> ${data.response}</div>
      </div>
      <div class="timestamp">${getTime()}</div>
    </div>`;
  updateStats(data.emotion);
  scrollToBottom();
});
</script>
</body>
</html>
